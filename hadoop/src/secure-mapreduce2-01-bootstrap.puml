@startuml
title Secure Map Reduce 2 - HDFS & YARN Bootstrap
autonumber
'hide footbox

participant "Name\nNode\n(nn)" as NN
participant "Data\nNode\n(dn)" as DN
'participant "Client\n(c)" as C
participant "Resource\nManager\n(rm)" as RM
participant "Node\nManager\n(nm)" as NM
'participant "Shuffle\nService\n(ss)" as SS
'participant "History\nServer\n(hs)" as HS
'participant "Application\nMaster\n(am)" as AM
'participant "Client\nService\n(cs)" as CS
'participant "Application\nContainer\n(ac)" as AC #red
'participant "Task\n(t)" as T #orange
'participant "File\nSystem\n(fs)" as FS
participant "Kerberos\nKDC" as KDC


  'note over RM,DN #green: QUESTION: ?

== HDFS ==

'1
NN->NN: <b>createBlockAccessTokenSecretKey()\n : blk-tkn-sk
  note right: For DNs to validate BTs from clients and services.
  activate NN
  deactivate NN

...

'2
DN->KDC:<b>kinit/AS_REQ\n [KRB]\n ( dn-kp )\n : AS_REP{dn-tgt}
  note left: DN's dn-tgt decrypted with\npassword in DN keytab.
  activate DN

'3
DN->KDC:<b>TGS_REQ\n [KRB(dn-tgt)]\n ( nn-kp )\n : TGS_REP{dn-nn-kst}
  note left: Service Ticket dn-nn-kst\nstored in DNs ticket cache.

'4
DN->NN: <b>register/heartbeat\n [RSKT(dn-nn-kst)]\n ( dn-status )\n : blk-tkn-sk
  note right: Distribute blk-tkn-sk to all DNs
  deactivate DN

== YARN ==
  note over RM,DN #green: Q1: Used between what components?
'5
RM->RM:<b>createNodeManagerTokenSecretKey()\n : nm-tkn-sk
  note left: Used by TODO to validate nm-tkn from TODO.
  activate RM

  note over RM,DN #green: Q2: Used between which components?
'6
RM->RM:<b>createAppContainerTokenSecretKey()\n : ac-tkn-sk
  note left: Used by TODO to validate ac-tkn from TODO.
  deactivate RM

...

'7
NM->KDC:<b>kinit/AS_REQ\n [KRB]\n ( nm-kp )\n : AS_REP{nm-tgt}
  note left: Password used to decrypt nm-tgt from NM's keytab.
  activate NM

'8
NM->KDC:<b>TGS_REQ\n [KRB(nm-tgt)]\n ( rm-kp )\n : TGS_REP{nm-rm-kst}
  note left: Service ticket nm-rm-kst stored in NM's ticket cache.

'9
NM->RM:<b>register/heartbeat\n [RSKT(nm-rm-kst)]\n ( nm-status )\n : nm-tkn-sk, ac-tkn-sk
  note left: Distribute nm-tkn-sk and ac-tkn-sk to all NMs
  deactivate NM

@enduml