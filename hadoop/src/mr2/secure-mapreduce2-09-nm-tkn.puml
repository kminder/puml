@startuml
title Secure Map Reduce 2 - Node Manager Token Flow
autonumber
'hide footbox

'participant "Client\n(c)" as C
participant "Resource\nManager\n(rm)" as RM
'participant "History\nServer\n(hs)" as HS
participant "Node\nManager\n(nm)" as NM
'participant "Shuffle\nHandler\n(ss)" as SS
participant "Application\nMaster\n(am)" as AM
'participant "Client\nService\n(cs)" as CS
'participant "Application\nContainer\n(ac)" as AC #red
'participant "Task\n(t)" as T #orange
'participant "File\nSystem\n(fs)" as FS
'participant "Name\nNode\n(nn)" as NN
'participant "Data\nNode\n(dn)" as DN
'participant "Kerberos\nKDC" as KDC

'note over C,KDC #green: QUESTION ?

== Bootstrap ==

'1
RM->RM:<b>createNodeManagerTokenMasterKey</b>(): nm-tkn-mk
  note right: Secret shared with NodeManagers to verify NodeManager Tokens.

'2
NM->RM:<b>registerNodeManager/nodeHeartbeat</b>[...](...): nm-tkn-mk, ...
  note right: Share nm-tkn-mk with NodeManagers.

== Job Submission ==

== Job Initiation ==

'3
[->RM: <b>runJob?
  note right #green: Q1: How are jobs are discovered on the queue?
  activate RM

'4
RM->RM: <b>allocateResources</b>(...)
  note right: Call to self to allocate resources for MapReduce AppMaster.
  activate RM

'5
RM->RM: <b>createNodeManagerToken</b>( nm-tkn-mk ): am-nm-tkn
  note right: NodeManager Token to access NodeManager and start AppContainer for MapReduce AppMaster.

'6
RM<--RM: <b>:am-alloc-res</b>{am-nm-tkn,...}
  note right: NM Token returned from allocationResources() as part of AllocatedContainer.
  deactivate RM

'7
RM->NM: <b>startContainer</b> [RSAT(am-nm-tkn)] (...)
  note right: SASL verifies am-nn-tkn with bm-tkn-mk
  deactivate RM

== Map Task Execution ==

'8
AM->RM: <b>allocateResources</b>[...](...)
  note right: Allocate AppContainer for MapTask.
  activate RM

'9
RM->RM: <b>createNodeManagerToken</b>( nm-tkn-mk ): mt-nm-tkn
  note right: NodeManager token to access NodeManager and start AppContainer for MapTask.

'10
AM<--RM: <b>:mt-alloc-res</b>{mt-nm-tkn,...}
  note right: NM Token returned as part of AllocatedContainer.
  deactivate RM

'11
AM->NM: <b>startContainer</b> [RSAT(mt-nm-tkn)] (...)
  note right: SASL verifies mt-nn-tkn with nn-tkn-mk

== Reduce Task Execution ==

'12
AM->RM: <b>allocateResources</b>[...](...)
  note right: Allocate AppContainer for ReduceTask.
  activate RM

'13
RM->RM: <b>createNodeManagerToken</b> ( nm-tkn-mk ): rt-nm-tkn
  note right: NodeManager Token to access NodeManager and start AppContainer for ReduceTask.

'14
AM<--RM: <b>:mt-alloc-res</b>{rt-nm-tkn,...}
  note right: NM Token returned as part of AllocatedContainer.
  deactivate RM

'15
AM->NM: <b>startContainer</b> [RSAT(rt-nm-tkn)] (...)
  note right: SASL verifies rt-nn-tkn with nn-tkn-mk

@enduml